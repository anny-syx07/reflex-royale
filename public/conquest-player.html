<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Campus Conquest - Player</title>
    <link rel="stylesheet" href="/css/conquest.css">
    <style>
        .player-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .game-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-purple);
            text-align: center;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .timer-display {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-purple);
        }

        .timer-display.warning {
            color: #FF6B6B;
            animation: timerPulse 0.5s infinite;
        }

        @keyframes timerPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .round-display {
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        .grid-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .footer {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .your-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-purple);
        }

        .waiting-screen,
        .game-over-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-pink) 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .waiting-screen.show,
        .game-over-screen.show {
            display: flex;
        }

        .big-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .big-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .message {
            font-size: 18px;
            margin-bottom: 30px;
        }

        .final-rank {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }

        .final-score {
            font-size: 32px;
            margin-bottom: 30px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .back-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        /* Hide back button after joining */
        body.in-game .back-btn {
            display: none !important;
        }
    </style>
</head>

<body>
    <button class="back-btn" onclick="window.location.href='/player.html'" title="Quay l·∫°i">‚¨ÖÔ∏è</button>
    <div class="player-container" id="gameContainer" style="display: none;">
        <div class="header">
            <div class="game-title">üèõÔ∏è ƒê·∫†I CHI·∫æN GI·∫¢NG ƒê∆Ø·ªúNG</div>
            <div class="status-bar">
                <div class="round-display" id="roundDisplay">Round 1/12</div>
                <div class="timer-display" id="timer">12</div>
                <div class="ap-display" id="apDisplay"></div>
            </div>
        </div>

        <div class="grid-wrapper">
            <div id="gridContainer"></div>
        </div>

        <div class="footer">
            <div class="your-stats">
                <div class="stat">
                    <div class="stat-label">Your Territory</div>
                    <div class="stat-value" id="territoryCount">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Your Rank</div>
                    <div class="stat-value" id="playerRank">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Waiting Screen -->
    <div class="waiting-screen show" id="waitingScreen">
        <div class="big-icon">‚è≥</div>
        <div class="big-title">Waiting for Game...</div>
        <div class="message">Nh·∫≠p m√£ ph√≤ng ƒë·ªÉ tham gia</div>
        <div style="margin-top: 20px;">
            <input type="text" id="roomCodeInput" placeholder="Room Code"
                style="padding: 15px; font-size: 18px; border-radius: 8px; border: none; text-align: center; text-transform: uppercase; width: 200px; margin-bottom: 15px;">
            <br>
            <input type="text" id="nicknameInput" placeholder="Your Nickname"
                style="padding: 15px; font-size: 18px; border-radius: 8px; border: none; text-align: center; width: 200px; margin-bottom: 15px;">
            <br>
            <button onclick="joinGame()"
                style="padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 8px; border: none; background: white; color: var(--primary-purple); cursor: pointer;">
                Tham Gia
            </button>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div class="game-over-screen" id="gameOverScreen">
        <div class="big-icon">üèÜ</div>
        <div class="big-title">Tr√≤ Ch∆°i K·∫øt Th√∫c!</div>
        <div class="final-rank" id="finalRank">#1</div>
        <div class="final-score" id="finalScore">50 territories</div>
        <div class="message">C·∫£m ∆°n b·∫°n ƒë√£ ch∆°i!</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/conquest-game.js"></script>
    <script>
        const socket = io();

        let roomCode = null;
        let playerId = null;
        let nickname = '';
        let grid = null;
        let renderer = null;
        let currentAP = 3;
        let maxAP = 3;
        let pendingActions = [];
        let timerInterval = null;
        let failsafeTimeout = null; // Track failsafe timer

        // Auto-join from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomCode = urlParams.get('roomCode');
        const urlNickname = urlParams.get('nickname');

        if (urlRoomCode && urlNickname) {
            // Auto-join
            document.getElementById('roomCodeInput').value = urlRoomCode;
            document.getElementById('nicknameInput').value = urlNickname;
            setTimeout(() => joinGame(), 500);
        }

        // Join game
        function joinGame() {
            roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            nickname = document.getElementById('nicknameInput').value.trim() || 'Player';

            if (!roomCode) {
                alert('Vui l√≤ng nh·∫≠p m√£ ph√≤ng!');
                return;
            }

            socket.emit('joinConquestRoom', { roomCode, nickname });
        }

        // Socket: Successfully joined
        socket.on('conquestJoined', ({ roomCode: newRoomCode, playerId: newPlayerId }) => {
            playerId = newPlayerId;
            roomCode = newRoomCode;
            document.body.classList.add('in-game'); // Hide back button
            document.getElementById('waitingScreen').classList.remove('show');
            document.getElementById('gameContainer').style.display = 'flex';
        });

        // Socket: Round start
        socket.on('conquestRoundStart', (data) => {
            const { roundNumber, maxRounds, currentAP: ap, mapState } = data;

            // Update UI
            document.getElementById('roundDisplay').textContent = `Round ${roundNumber}/${maxRounds}`;
            currentAP = ap;
            maxAP = ap;
            pendingActions = [];
            hasSubmitted = false; // Reset for new round

            // Clear any existing timers
            if (timerInterval) clearInterval(timerInterval);
            if (failsafeTimeout) clearTimeout(failsafeTimeout);

            // Initialize or update grid
            if (!grid) {
                grid = new ConquestGrid(10);
                const container = document.getElementById('gridContainer');
                renderer = new ConquestRenderer(container, grid, { clickable: true });
                renderer.onCellClick = handleCellClick;
                renderer.render(); // Only render once on first round
            }

            // Update grid data and individual cells (DON'T re-render everything)
            grid.import(mapState);

            // Update only changed cells to preserve claimed territories
            for (let x = 0; x < grid.size; x++) {
                for (let y = 0; y < grid.size; y++) {
                    renderer.updateCell(x, y);
                }
            }

            updateAPDisplay();

            // Start timer
            startTimer(data.duration / 1000);
        });

        // Handle cell click
        function handleCellClick(x, y) {
            // Check if cell is already owned
            if (grid.getCell(x, y) !== null) {
                return;
            }

            const actionKey = `${x},${y}`;
            const actionIndex = pendingActions.findIndex(a => `${a.x},${a.y}` === actionKey);

            if (actionIndex >= 0) {
                // Undo action
                pendingActions.splice(actionIndex, 1);
                currentAP++;
                renderer.markPending(x, y, false);
                // Real-time indicators disabled
            } else {
                // Add action
                if (currentAP > 0) {
                    pendingActions.push({ x, y });
                    currentAP--;
                    renderer.markPending(x, y, true);
                    playSound('click');
                    // Real-time indicators disabled
                }
            }

            updateAPDisplay();
        }

        // Update AP display
        function updateAPDisplay() {
            const container = document.getElementById('apDisplay');
            container.innerHTML = '';

            for (let i = 0; i < maxAP; i++) {
                const dot = document.createElement('div');
                dot.className = 'ap-dot';
                if (i < maxAP - currentAP) {
                    dot.classList.add('active');
                }
                container.appendChild(dot);
            }
        }

        // Start countdown timer
        function startTimer(seconds) {
            let remaining = seconds;
            const timerEl = document.getElementById('timer');

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                remaining--;
                timerEl.textContent = remaining;

                if (remaining <= 3) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    console.log('[Conquest Client] Timer ended - auto submitting');
                    submitActions();
                }
            }, 1000);

            // Failsafe: Force submit after duration + 1s
            if (failsafeTimeout) clearTimeout(failsafeTimeout);
            failsafeTimeout = setTimeout(() => {
                console.log('[Conquest Client] Failsafe auto-submit triggered');
                submitActions();
            }, (seconds + 1) * 1000);
        }

        // Submit actions
        let hasSubmitted = false;
        function submitActions() {
            if (hasSubmitted) {
                console.log('[Conquest Client] Already submitted, skipping');
                return;
            }

            console.log('[Conquest Client] Submitting actions:', pendingActions);
            if (pendingActions.length > 0) {
                socket.emit('conquestSubmitActions', {
                    roomCode,
                    actions: pendingActions
                });
                hasSubmitted = true;
                console.log('[Conquest Client] Actions sent to server');
            } else {
                console.log('[Conquest Client] No actions to submit');
                hasSubmitted = true; // Mark as submitted even if empty
            }
        }

        // Socket: Round end
        socket.on('conquestRoundEnd', (data) => {
            const { mapState, conflicts, yourTerritory, yourRank } = data;

            // Update grid immediately (no delay!)
            grid.import(mapState);

            // Show conflicts briefly
            conflicts.forEach(({ x, y }) => {
                renderer.showConflict(x, y);
            });

            // Update all cells right away for fast response
            for (let x = 0; x < grid.size; x++) {
                for (let y = 0; y < grid.size; y++) {
                    renderer.updateCell(x, y);
                }
            }

            // Update stats
            document.getElementById('territoryCount').textContent = yourTerritory || 0;
            document.getElementById('playerRank').textContent = yourRank ? `#${yourRank}` : '-';

            // Reset pending
            pendingActions = [];
        });

        // Socket: Game over
        socket.on('conquestGameOver', (data) => {
            const { yourRank, yourTerritory } = data;

            document.getElementById('finalRank').textContent = `#${yourRank}`;
            document.getElementById('finalScore').textContent = `${yourTerritory} territories`;
            document.getElementById('gameOverScreen').classList.add('show');

            // Add Ch∆°i L·∫°i button
            const gameOverScreen = document.getElementById('gameOverScreen');
            const existingBtn = gameOverScreen.querySelector('.play-again-btn');
            if (!existingBtn) {
                const btn = document.createElement('button');
                btn.className = 'play-again-btn';
                btn.textContent = 'üéÆ CH∆†I L·∫†I';
                btn.style.cssText = 'padding: 15px 40px; margin-top: 30px; font-size: 18px; font-weight: bold; border-radius: 8px; border: none; background: white; color: var(--primary-purple); cursor: pointer;';
                btn.onclick = () => window.location.href = '/player.html';
                gameOverScreen.querySelector('div').appendChild(btn);
            }
            // No auto-redirect
        });

        // Socket: Error
        socket.on('error', (data) => {
            alert(data.message);
        });
    </script>
</body>

</html>