<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Conquest - Host</title>
    <link rel="stylesheet" href="/css/conquest.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .main-display {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .game-header {
            text-align: center;
            padding: 20px;
        }

        .game-title {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .game-subtitle {
            font-size: 20px;
            color: #666;
        }

        .grid-display {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .room-code-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            border-radius: 12px;
            color: white;
        }

        .room-code {
            font-size: 48px;
            font-weight: bold;
            letter-spacing: 8px;
            margin: 10px 0;
        }

        .waiting-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-pink) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .waiting-screen.hidden {
            display: none;
        }

        /* Floating Back Button */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .back-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <!-- Floating Back Button -->
    <button class="back-btn" onclick="window.location.href='/host.html'" title="Quay l·∫°i">‚¨ÖÔ∏è</button>
    <!-- Waiting Screen -->
    <div class="waiting-screen" id="waitingScreen">
        <h1 style="font-size: 64px; margin-bottom: 30px;">üèõÔ∏è ƒê·∫°i Chi·∫øn Gi·∫£ng ƒê∆∞·ªùng</h1>
        <button class="btn btn-primary" onclick="createRoom()">T·∫°o Ph√≤ng M·ªõi</button>
    </div>

    <!-- Main Game Display -->
    <div class="main-display" id="mainDisplay" style="display: none;">
        <div class="panel">
            <div class="game-header">
                <div class="game-title">üèõÔ∏è ƒê·∫†I CHI·∫æN GI·∫¢NG ƒê∆Ø·ªúNG</div>
                <div class="game-subtitle" id="gameStatus">Waiting for players...</div>
            </div>
        </div>

        <div class="panel">
            <div class="round-info">
                <div class="round-number" id="roundDisplay">Round 1/12</div>
                <div class="timer" id="timer">12</div>
            </div>
        </div>

        <div class="panel">
            <div class="grid-display">
                <div id="gridContainer"></div>
            </div>
        </div>

        <div class="panel">
            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startGame()">B·∫Øt ƒê·∫ßu Tr√≤ Ch∆°i</button>
                <button class="btn btn-secondary" id="nextBtn" onclick="nextRound()" style="display: none;">V√≤ng Ti·∫øp
                    Theo</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="panel room-code-display">
            <div>M√£ Ph√≤ng</div>
            <div class="room-code" id="roomCode">------</div>
            <div style="font-size: 16px;">Ng∆∞·ªùi ch∆°i nh·∫≠p m√£ n√†y ƒë·ªÉ tham gia</div>
        </div>

        <div class="panel">
            <div class="leaderboard">
                <div class="leaderboard-title">üèÜ TOP 10</div>
                <div id="leaderboardList"></div>
            </div>
        </div>

        <div class="panel">
            <div class="stats-panel">
                <div class="stat-item">
                    <span class="stat-label">Ng∆∞·ªùi ch∆°i</span>
                    <span class="stat-value" id="playerCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Cells chi·∫øm</span>
                    <span class="stat-value" id="totalCells">0</span>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/conquest-game.js"></script>
    <script>
        const socket = io();

        let roomCode = null;
        let grid = null;
        let renderer = null;
        let timerInterval = null;

        function createRoom() {
            socket.emit('createConquestRoom');
        }

        socket.on('conquestRoomCreated', (data) => {
            roomCode = data.roomCode;
            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('mainDisplay').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'flex';

            // Initialize grid
            grid = new ConquestGrid(10);
            grid.initializeSpecialCells(8);
            const container = document.getElementById('gridContainer');
            renderer = new ConquestRenderer(container, grid, {
                large: true,
                clickable: false
            });
        });

        socket.on('conquestPlayerListUpdate', (data) => {
            document.getElementById('playerCount').textContent = data.players.length;
        });

        function startGame() {
            socket.emit('startConquestGame', { roomCode });
            document.getElementById('startBtn').style.display = 'none';
        }

        socket.on('conquestGameStarted', () => {
            document.getElementById('gameStatus').textContent = 'Game in progress...';
        });

        socket.on('conquestRoundStart', (data) => {
            const { roundNumber, maxRounds, mapState, duration } = data;

            document.getElementById('roundDisplay').textContent = `Round ${roundNumber}/${maxRounds}`;

            // Reset next round button
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.style.display = 'none';
            nextBtn.disabled = false;
            nextBtn.textContent = 'V√≤ng Ti·∫øp Theo';
            nextBtn.style.opacity = '1';

            grid.import(mapState);
            renderer.render();

            // Real-time player cell selections
            // const playerPendingCells = new Map(); // playerId -> [{x, y}]

            // socket.on('conquestPlayerCellUpdate', ({ playerId, playerNickname, x, y, action }) => {
            //     if (!playerPendingCells.has(playerId)) {
            //         playerPendingCells.set(playerId, []);
            //     }

            //     const cells = playerPendingCells.get(playerId);

            //     if (action === 'add') {
            //         cells.push({ x, y });
            //     } else if (action === 'remove') {
            //         const index = cells.findIndex(c => c.x === x && c.y === y);
            //         if (index >= 0) cells.splice(index, 1);
            //     }

            //     // Update cell display
            //     updatePendingCellDisplay();
            // });

            // function updatePendingCellDisplay() {
            //     // Clear all pending indicators first
            //     document.querySelectorAll('.pending-indicator').forEach(el => el.remove());

            //     // Add indicators for each player's pending cells
            //     playerPendingCells.forEach((cells, playerId) => {
            //         cells.forEach(({ x, y }) => {
            //             const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
            //             if (cell && !cell.classList.contains('owned')) {
            //                 // Add small indicator
            //                 const indicator = document.createElement('div');
            //                 indicator.className = 'pending-indicator';
            //                 indicator.textContent = 'üë§';
            //                 indicator.style.cssText = `
            //                     position: absolute; 
            //                     top: 2px; 
            //                     left: 2px; 
            //                     font-size: 12px;
            //                     pointer-events: none;
            //                 `;
            //                 cell.style.position = 'relative';
            //                 cell.appendChild(indicator);
            //             }
            //         });
            //     });
            // }

            // Real-time indicators removed - don't spoil player strategy!
            // socket.on('conquestPlayerCellUpdate', ...) - DISABLED

            socket.on('conquestMapUpdate', (data) => {
                const { grid: gridData, leaderboard, conflictsThisRound } = data;

                // Update grid data
                grid.grid = gridData;

                // Update only changed cells instead of full re-render
                for (let x = 0; x < grid.size; x++) {
                    for (let y = 0; y < grid.size; y++) {
                        renderer.updateCell(x, y);
                    }
                }

                // Show conflicts
                conflictsThisRound.forEach(({ x, y }) => {
                    renderer.showConflict(x, y);
                });

                // Update leaderboard
                updateLeaderboard(leaderboard);

                // Count total claimed cells
                let total = 0;
                for (let x = 0; x < grid.size; x++) {
                    for (let y = 0; y < grid.size; y++) {
                        if (grid.grid[x][y] !== null) total++;
                    }
                }
                document.getElementById('totalCells').textContent = total;
            });

            socket.on('conquestRoundEnd', () => {
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                document.getElementById('nextBtn').style.display = 'inline-block';
            });

            socket.on('conquestGameOver', (data) => {
                document.getElementById('gameStatus').textContent = 'üéâ Tr√≤ Ch∆°i K·∫øt Th√∫c!';
                document.getElementById('nextBtn').style.display = 'none';
                updateLeaderboard(data.finalLeaderboard);
            });

            // Start round timer
            startTimer(duration / 1000);
        });

        // Functions in global scope
        function nextRound() {
            // Disable button immediately for visual feedback
            const btn = document.getElementById('nextBtn');
            btn.disabled = true;
            btn.textContent = 'ƒêang x·ª≠ l√Ω...';
            btn.style.opacity = '0.5';

            socket.emit('conquestNextRound', { roomCode });
        }

        function startTimer(seconds) {
            let remaining = seconds;
            const timerEl = document.getElementById('timer');

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                remaining--;
                timerEl.textContent = remaining;

                if (remaining <= 3) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function updateLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboardList');
            container.innerHTML = '';

            leaderboard.slice(0, 10).forEach((player, index) => {
                const item = document.createElement('div');
                item.className = `leaderboard-item rank-${index + 1}`;

                const rankBadge = document.createElement('div');
                rankBadge.className = 'rank-badge';
                rankBadge.textContent = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;

                const name = document.createElement('div');
                name.className = 'player-name';
                name.textContent = player.nickname;

                const score = document.createElement('div');
                score.className = 'player-score';
                score.textContent = player.territory || 0;

                item.appendChild(rankBadge);
                item.appendChild(name);
                item.appendChild(score);
                container.appendChild(item);
            });
        }
    </script>
</body>

</html>