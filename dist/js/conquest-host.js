const socket=io();let roomCode=null,grid=null,renderer=null,timerInterval=null;const els={waitingScreen:document.getElementById("waitingScreen"),mainDisplay:document.getElementById("mainDisplay"),sidebar:document.getElementById("sidebar"),roomCode:document.getElementById("roomCode"),playerCount:document.getElementById("playerCount"),gridContainer:document.getElementById("gridContainer"),gameStatus:document.getElementById("gameStatus"),timerValue:document.getElementById("timer"),startBtn:document.getElementById("startBtn"),nextBtn:document.getElementById("nextBtn"),leaderboardList:document.getElementById("leaderboardList"),roundInfo:document.getElementById("roundDisplay")};function createRoom(){socket.emit("createConquestRoom")}function startGame(){socket.emit("startConquestGame",{roomCode:roomCode})}function startTimer(e){console.log("[Conquest Host] Starting timer with duration:",e),timerInterval&&clearInterval(timerInterval);let t=e/1e3;els.timerValue?(els.timerValue.textContent=t,els.timerValue.classList.remove("warning"),console.log("[Conquest Host] Timer element found, updating to:",t),timerInterval=setInterval(()=>{t--,els.timerValue.textContent=Math.max(0,t),t<=3?els.timerValue.classList.add("warning"):els.timerValue.classList.remove("warning"),t<=0&&(clearInterval(timerInterval),timerInterval=null)},1e3)):console.error("[Conquest Host] Timer element NOT FOUND!")}function nextRound(){socket.emit("conquestNextRound",{roomCode:roomCode}),els.nextBtn.style.display="none"}function updateLeaderboard(e){const t=els.leaderboardList;if(!t)return;t.innerHTML="";e.sort((e,t)=>(t.territory||0)-(e.territory||0)).slice(0,10).forEach((e,n)=>{const o=document.createElement("div");o.className="leaderboard-item";const r=document.createElement("div");r.className="rank-badge",r.textContent=`#${n+1}`;const a=document.createElement("div");a.className="player-name",a.textContent=e.nickname;const l=document.createElement("div");l.className="player-score",l.textContent=e.territory||0,o.appendChild(r),o.appendChild(a),o.appendChild(l),t.appendChild(o)})}function cleanupConquestHost(){timerInterval&&(clearInterval(timerInterval),timerInterval=null),renderer&&(renderer=null),grid&&(grid=null),socket&&socket.removeAllListeners()}socket.on("conquestRoomCreated",e=>{roomCode=e.roomCode,els.roomCode.textContent=roomCode,els.waitingScreen.classList.add("hidden"),els.mainDisplay.style.display="flex",els.sidebar.style.display="flex",grid=new ConquestGrid(10),grid.initializeSpecialCells(8),renderer=new ConquestRenderer(els.gridContainer,grid,{large:!0,clickable:!1})}),socket.on("conquestPlayerListUpdate",e=>{els.playerCount.textContent=e.players.length,updateLeaderboard(e.players)}),socket.on("conquestGameStarted",()=>{els.startBtn.style.display="none",els.gameStatus.textContent="TrÃ² chÆ¡i Ä‘ang báº¯t Ä‘áº§u..."}),socket.on("conquestRoundStart",e=>{console.log("[Conquest Host] Round started:",e),els.gameStatus.textContent=`VÃ²ng ${e.roundNumber}/${e.maxRounds}`,els.roundInfo&&(els.roundInfo.textContent=`Round ${e.roundNumber}/${e.maxRounds}`),startTimer(e.duration)}),socket.on("conquestMapUpdate",e=>{if(renderer&&grid){if(e.grid)for(let t=0;t<10;t++)for(let n=0;n<10;n++)grid.setCell(t,n,e.grid[t][n]);renderer.render()}}),socket.on("conquestPlayerCellUpdate",e=>{if(renderer){const{x:t,y:n,action:o,playerNickname:r}=e,a=document.querySelector(`[data-x="${t}"][data-y="${n}"]`);a&&("add"===o?(a.classList.add("player-selecting"),a.setAttribute("data-player",r)):(a.classList.remove("player-selecting"),a.removeAttribute("data-player")))}}),socket.on("conquestRoundEnd",e=>{els.gameStatus.textContent="VÃ²ng káº¿t thÃºc!",els.nextBtn.style.display="block",updateLeaderboard(e.leaderboard)}),socket.on("conquestGameOver",e=>{els.gameStatus.textContent="ğŸ‰ TrÃ² ChÆ¡i Káº¿t ThÃºc!",els.nextBtn.style.display="none",updateLeaderboard(e.finalLeaderboard)}),window.addEventListener("beforeunload",cleanupConquestHost);