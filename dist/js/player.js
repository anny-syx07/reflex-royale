const socket=io();let roomCode=null,playerId=null,currentScore=0,currentRoundType=null,roundStartTime=null,shakeCount=0,lastShakeTime=0,shakeInterval=null,tapCount=0,touchStartX=0,touchStartY=0;const joinScreen=document.getElementById("joinScreen"),waitingScreen=document.getElementById("waitingScreen"),gameScreen=document.getElementById("gameScreen"),roomCodeInput=document.getElementById("roomCodeInput"),nicknameInput=document.getElementById("nicknameInput"),joinBtn=document.getElementById("joinBtn"),errorMessage=document.getElementById("errorMessage"),colorButtons=document.getElementById("colorButtons"),swipeArea=document.getElementById("swipeArea"),swipeIndicator=document.getElementById("swipeIndicator"),shakeArea=document.getElementById("shakeArea"),shakeCountEl=document.getElementById("shakeCount"),tapSpamArea=document.getElementById("tapSpamArea"),tapSpamBtn=document.getElementById("tapSpamBtn"),tapCountEl=document.getElementById("tapCount"),scoreValue=document.getElementById("scoreValue"),feedback=document.getElementById("feedback"),urlParams=new URLSearchParams(window.location.search),urlRoomCode=urlParams.get("roomCode"),urlNickname=urlParams.get("nickname");function showError(e){errorMessage.textContent=e,errorMessage.classList.remove("hidden"),setTimeout(()=>{errorMessage.classList.add("hidden")},3e3)}function setupSwipeDetection(){swipeArea.addEventListener("touchstart",handleSwipeStart,{passive:!1}),swipeArea.addEventListener("touchmove",handleSwipeMove,{passive:!1}),swipeArea.addEventListener("touchend",handleSwipeEnd,{passive:!1})}function handleSwipeStart(e){e.preventDefault(),touchStartX=e.touches[0].clientX,touchStartY=e.touches[0].clientY}function handleSwipeMove(e){e.preventDefault();const t=e.touches[0].clientX-touchStartX,n=e.touches[0].clientY-touchStartY;if(Math.abs(t)>30||Math.abs(n)>30){let e="";e=Math.abs(t)>Math.abs(n)?t>0?"âž¡ï¸":"â¬…ï¸":n>0?"â¬‡ï¸":"â¬†ï¸",swipeIndicator.textContent=e,swipeIndicator.classList.add("show")}}function handleSwipeEnd(e){e.preventDefault();const t=e.changedTouches[0].clientX-touchStartX,n=e.changedTouches[0].clientY-touchStartY;let o=null;Math.abs(t)>Math.abs(n)?Math.abs(t)>50&&(o=t>0?"RIGHT":"LEFT"):Math.abs(n)>50&&(o=n>0?"DOWN":"UP"),o&&sendResponse(o),setTimeout(()=>{swipeIndicator.classList.remove("show")},300)}function setupShakeDetection(){"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(e=>{"granted"===e&&window.addEventListener("devicemotion",handleShake)}).catch(console.error):window.addEventListener("devicemotion",handleShake),shakeInterval=setInterval(()=>{"SHAKE"===currentRoundType&&socket.emit("shakeUpdate",{roomCode:roomCode,shakeCount:shakeCount})},200)}function handleShake(e){if("SHAKE"!==currentRoundType)return;const t=e.accelerationIncludingGravity,n=Date.now();n-lastShakeTime<100||(Math.abs(t.x)>15||Math.abs(t.y)>15||Math.abs(t.z)>15)&&(shakeCount++,shakeCountEl.textContent=shakeCount,lastShakeTime=n,navigator.vibrate&&navigator.vibrate(10))}function setupTapSpam(){tapCount=0,tapCountEl.textContent="0",tapSpamBtn.addEventListener("click",handleTapSpam);const e=setInterval(()=>{"TAP_SPAM"===currentRoundType?socket.emit("tapUpdate",{roomCode:roomCode,tapCount:tapCount}):clearInterval(e)},200)}function handleTapSpam(){"TAP_SPAM"===currentRoundType&&(tapCount++,tapCountEl.textContent=tapCount,navigator.vibrate&&navigator.vibrate(10))}function sendResponse(e){const t=Date.now();socket.emit("playerResponse",{roomCode:roomCode,response:e,timestamp:t})}function cleanupSocket(){socket&&socket.removeAllListeners(),document.body.classList.remove("in-game")}urlRoomCode&&urlNickname&&(roomCodeInput.value=urlRoomCode,nicknameInput.value=urlNickname,setTimeout(()=>joinBtn.click(),500)),joinBtn.addEventListener("click",()=>{const e=roomCodeInput.value.trim().toUpperCase(),t=nicknameInput.value.trim()||"Player"+Math.floor(1e3*Math.random());e&&4===e.length?socket.emit("joinRoom",{roomCode:e,nickname:t}):showError("Vui lÃ²ng nháº­p mÃ£ phÃ²ng 4 sá»‘!")}),nicknameInput.addEventListener("keypress",e=>{"Enter"===e.key&&joinBtn.click()}),socket.on("joinedRoom",({roomCode:e,playerId:t})=>{roomCode=e,playerId=t,document.body.classList.add("in-game"),joinScreen.classList.add("hidden"),waitingScreen.classList.remove("hidden"),console.log("Joined room:",e)}),socket.on("error",({message:e})=>{showError(e)}),socket.on("gameStarted",()=>{waitingScreen.classList.add("hidden"),gameScreen.classList.remove("hidden")}),socket.on("roundStart",({roundType:e,roundData:t,startTime:n})=>{currentRoundType=e,roundStartTime=n,colorButtons.classList.add("hidden"),swipeArea.classList.add("hidden"),shakeArea.classList.add("hidden"),tapSpamArea.classList.add("hidden"),shakeCount=0,tapCount=0,shakeCountEl.textContent="0",tapCountEl.textContent="0","COLOR_TAP"===e?colorButtons.classList.remove("hidden"):"SWIPE"===e?(swipeArea.classList.remove("hidden"),setupSwipeDetection()):"SHAKE"===e?(shakeArea.classList.remove("hidden"),setupShakeDetection()):"TAP_SPAM"===e&&(tapSpamArea.classList.remove("hidden"),setupTapSpam())}),document.querySelectorAll(".color-btn").forEach(e=>{e.addEventListener("click",e=>{if("COLOR_TAP"!==currentRoundType)return;sendResponse(e.target.dataset.color),e.target.style.transform="scale(0.9)",setTimeout(()=>{e.target.style.transform="scale(1)"},100)})}),socket.on("responseResult",({correct:e,points:t,totalScore:n})=>{currentScore=n,scoreValue.textContent=currentScore,void 0!==e&&(feedback.textContent=e?`+${t} âœ“`:`${t} âœ—`,feedback.className=e?"feedback correct":"feedback incorrect",feedback.classList.remove("hidden"),setTimeout(()=>{feedback.classList.add("hidden")},1500)),navigator.vibrate&&navigator.vibrate(e?[50]:[50,50,50])}),socket.on("roundEnd",()=>{shakeInterval&&(clearInterval(shakeInterval),shakeInterval=null),window.removeEventListener("devicemotion",handleShake),colorButtons.classList.add("hidden"),swipeArea.classList.add("hidden"),shakeArea.classList.add("hidden"),tapSpamArea.classList.add("hidden")}),socket.on("gameOver",({finalLeaderboard:e})=>{const t=e.findIndex(e=>e.id===playerId)+1,n=e.length,o=document.createElement("div");o.className="container";const a=document.createElement("h1");a.className="game-title text-gradient",a.textContent="ðŸŽ‰ HOÃ€N THÃ€NH! ðŸŽ‰";const s=document.createElement("div");s.className="glass",s.style.cssText="padding: 2rem; border-radius: 1rem; text-align: center;";const r=document.createElement("h2");r.style.cssText="font-size: 3rem; color: var(--color-yellow); margin-bottom: 1rem;",r.textContent=`#${t} / ${n}`;const c=document.createElement("p");c.style.cssText="font-size: 1.5rem; color: var(--text-secondary);",c.innerHTML=`Tá»•ng Ä‘iá»ƒm: <strong style="color: var(--color-yellow);">${currentScore}</strong>`;const d=document.createElement("button");d.className="btn btn-primary btn-lg",d.textContent="ðŸŽ® CHÆ I Láº I",d.style.marginTop="2rem",d.onclick=()=>{cleanupSocket(),window.history.replaceState({},document.title,"/player.html"),window.location.href="/player.html"},s.appendChild(r),s.appendChild(c),s.appendChild(d),o.appendChild(a),o.appendChild(s),gameScreen.innerHTML="",gameScreen.appendChild(o)}),socket.on("hostDisconnected",()=>{console.log("Host disconnected - player stays on results screen")}),window.addEventListener("beforeunload",cleanupSocket);