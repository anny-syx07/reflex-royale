const socket=io();let roomCode=null,currentRoundType=null,roundTimer=null,globalTimer=null,roundTimeLeft=0;const gameState={phase:"WAITING",roundNumber:0,totalRounds:7},waitingScreen=document.getElementById("waitingScreen"),gameScreen=document.getElementById("gameScreen"),gameOverScreen=document.getElementById("gameOverScreen"),roomCodeEl=document.getElementById("roomCode"),playerCountEl=document.getElementById("playerCount"),playerListEl=document.getElementById("playerList"),startGameBtn=document.getElementById("startGameBtn"),currentRoundEl=document.getElementById("currentRound"),totalRoundsEl=document.getElementById("totalRounds"),roundDisplayEl=document.getElementById("roundDisplay"),leaderboardEl=document.getElementById("leaderboard"),finalLeaderboardEl=document.getElementById("finalLeaderboard"),newGameBtn=document.getElementById("newGameBtn"),timerValueEl=document.getElementById("timerValue"),nextRoundBtn=document.getElementById("nextRoundBtn");function startGlobalTimer(e){roundTimeLeft=e,timerValueEl.textContent=roundTimeLeft,globalTimer=setInterval(()=>{roundTimeLeft--,timerValueEl.textContent=Math.max(0,roundTimeLeft),roundTimeLeft<=0&&clearInterval(globalTimer)},1e3)}function displayColorRound(e){const n=document.createElement("div");n.className=`color-display color-${e}`,n.innerHTML=`\n        ${{RED:"Äá»",BLUE:"XANH",YELLOW:"VÃ€NG",PURPLE:"TÃM"}[e]}\n        <div class="instruction-text">Cháº¡m vÃ o mÃ u nÃ y!</div>\n    `,roundDisplayEl.appendChild(n)}function displaySwipeRound(e){const n=document.createElement("div");n.className="arrow-display",n.innerHTML=`\n        <div>${{UP:"â¬†ï¸",DOWN:"â¬‡ï¸",LEFT:"â¬…ï¸",RIGHT:"â¡ï¸"}[e]}</div>\n        <div style="font-size: 2rem; margin-top: 20px;">Vuá»‘t ${{UP:"LÃŠN",DOWN:"XUá»NG",LEFT:"TRÃI",RIGHT:"PHáº¢I"}[e]}!</div>\n    `,roundDisplayEl.appendChild(n)}function displayShakeRound(e){const n=document.createElement("div");n.className="shake-display",n.innerHTML=`\n    <h2>ğŸ¥Š Láº®C ÄIá»†N THOáº I! ğŸ¥Š</h2>\n    <div class="energy-bar-container">\n      <div class="energy-bar" id="energyBar" style="width: 0%"></div>\n      <div class="energy-text" id="energyText">0 / 0</div>\n    </div>\n    <div class="countdown" id="countdown">${e/1e3}</div>\n  `,roundDisplayEl.appendChild(n);let t=e/1e3;const o=document.getElementById("countdown");roundTimer=setInterval(()=>{t--,o.textContent=t,t<=0&&clearInterval(roundTimer)},1e3)}function displayTapSpamRound(e){const n=document.createElement("div");n.className="tap-display",n.innerHTML=`\n    <h2>ğŸ‘† CHáº M LIÃŠN Tá»¤C! ğŸ‘†</h2>\n    <div class="tap-button-demo">GO!</div>\n    <div class="countdown" id="countdown">${e/1e3}</div>\n  `,roundDisplayEl.appendChild(n);let t=e/1e3;const o=document.getElementById("countdown");roundTimer=setInterval(()=>{t--,o.textContent=t,t<=0&&clearInterval(roundTimer)},1e3)}function cleanupHost(){globalTimer&&clearInterval(globalTimer),roundTimer&&clearInterval(roundTimer),globalTimer=null,roundTimer=null,socket&&socket.removeAllListeners()}socket.emit("createRoom"),socket.on("roomCreated",({roomCode:e})=>{roomCode=e,roomCodeEl.textContent=e,console.log("Room created:",e)}),socket.on("playerListUpdate",({players:e})=>{playerCountEl.textContent=e.length,playerListEl.innerHTML="",e.forEach(e=>{const n=document.createElement("div");n.className="player-card",n.textContent=e.nickname,playerListEl.appendChild(n)}),startGameBtn.disabled=0===e.length}),startGameBtn.addEventListener("click",()=>{socket.emit("startGame",{roomCode:roomCode})}),nextRoundBtn.addEventListener("click",()=>{socket.emit("nextRound",{roomCode:roomCode})}),socket.on("gameStarted",()=>{waitingScreen.classList.add("hidden"),gameScreen.classList.remove("hidden")}),socket.on("roundStart",({roundNumber:e,totalRounds:n,roundType:t,roundData:o,startTime:a})=>{currentRoundEl.textContent=e,totalRoundsEl.textContent=n,currentRoundType=t,nextRoundBtn.style.display="none",roundDisplayEl.innerHTML="",globalTimer&&clearInterval(globalTimer),roundTimer&&clearInterval(roundTimer),"COLOR_TAP"===t?(displayColorRound(o.color),startGlobalTimer(5)):"SWIPE"===t?(displaySwipeRound(o.direction),startGlobalTimer(5)):"SHAKE"===t?(displayShakeRound(o.duration),startGlobalTimer(o.duration/1e3)):"TAP_SPAM"===t&&(displayTapSpamRound(o.duration),startGlobalTimer(o.duration/1e3))}),socket.on("energyBarUpdate",({totalShakes:e,maxShakes:n})=>{const t=document.getElementById("energyBar"),o=document.getElementById("energyText");if(t&&o){const a=Math.min(100,e/n*100);t.style.width=a+"%",o.textContent=`${e} / ${n}`}}),socket.on("leaderboardUpdate",({leaderboard:e})=>{leaderboardEl.innerHTML="",e.forEach((e,n)=>{const t=document.createElement("div");t.className="leaderboard-item",t.innerHTML=`\n      <div class="rank rank-${n+1}">#${n+1}</div>\n      <div class="player-name">${e.nickname}</div>\n      <div class="player-score">${e.score}</div>\n    `,leaderboardEl.appendChild(t)})}),socket.on("roundEnd",()=>{roundTimer&&clearInterval(roundTimer),globalTimer&&clearInterval(globalTimer),timerValueEl.textContent="âœ“",nextRoundBtn.style.display="inline-block"}),socket.on("gameOver",({finalLeaderboard:e})=>{gameScreen.classList.add("hidden"),gameOverScreen.classList.remove("hidden"),finalLeaderboardEl.innerHTML="",e.forEach((e,n)=>{const t=document.createElement("div");t.className="leaderboard-item",t.innerHTML=`\n      <div class="rank rank-${n+1}">#${n+1}</div>\n      <div class="player-name">${e.nickname}</div>\n      <div class="player-score">${e.score} Ä‘iá»ƒm</div>\n    `,finalLeaderboardEl.appendChild(t)})}),newGameBtn.addEventListener("click",()=>{cleanupHost(),window.location.href="/host.html"}),socket.on("hostDisconnected",()=>{alert("Host Ä‘Ã£ ngáº¯t káº¿t ná»‘i!"),cleanupHost(),location.reload()}),window.addEventListener("beforeunload",cleanupHost);